<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–∏—Å—å–º–∞</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1200px; margin: 20px auto; padding: 20px; }
        .container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .panel { border: 1px solid #ddd; padding: 20px; border-radius: 8px; }
        h2 { margin-top: 0; }
        input, textarea, button { width: 100%; padding: 10px; margin: 10px 0; }
        textarea { min-height: 100px; }
        button { background: #007bff; color: white; border: none; cursor: pointer; }
        button:hover { background: #0056b3; }
        .result { background: #f8f9fa; padding: 15px; border-radius: 4px; margin: 10px 0; }
        .error { background: #f8d7da; color: #721c24; }
        .success { background: #d4edda; color: #155724; }
        iframe { width: 100%; height: 600px; border: 1px solid #ddd; }
    </style>
</head>
<body>
    <h1>üß™ –¢–µ—Å—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ email</h1>
    
    <div class="container">
        <div class="panel">
            <h2>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã</h2>
            
            <label>Event ID:</label>
            <input type="number" id="eventId" value="1" />
            
            <label>Template ID:</label>
            <input type="number" id="templateId" value="138" />
            
            <label>–¢–µ–º–∞ –ø–∏—Å—å–º–∞:</label>
            <textarea id="theme">–ê–Ω–æ–Ω—Å —Å–ø–∏–∫–µ—Ä–æ–≤ –ø–æ –∞–¥–∞–ø—Ç–∞—Ü–∏–∏ –∏ –º–æ—Ç–∏–≤–∞—Ü–∏–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</textarea>
            
            <button onclick="generateEmail()">üöÄ –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–∏—Å—å–º–æ</button>
            
            <div id="status"></div>
        </div>
        
        <div class="panel">
            <h2>–†–µ–∑—É–ª—å—Ç–∞—Ç</h2>
            <div id="response"></div>
        </div>
    </div>
    
    <div class="panel" style="margin-top: 20px;">
        <h2>–ü—Ä–µ–≤—å—é –ø–∏—Å—å–º–∞</h2>
        <iframe id="preview"></iframe>
    </div>

    <script>
        async function generateEmail() {
            const statusEl = document.getElementById('status');
            const responseEl = document.getElementById('response');
            const previewEl = document.getElementById('preview');
            
            statusEl.innerHTML = '<div class="result">‚è≥ –ì–µ–Ω–µ—Ä–∏—Ä—É—é –ø–∏—Å—å–º–æ...</div>';
            responseEl.innerHTML = '';
            
            try {
                const response = await fetch('https://functions.poehali.dev/d2a2e722-c697-4c1e-a3c7-af2366b408af', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        event_id: parseInt(document.getElementById('eventId').value),
                        template_id: parseInt(document.getElementById('templateId').value),
                        theme: document.getElementById('theme').value,
                        test_mode: true
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    statusEl.innerHTML = '<div class="result success">‚úÖ –ü–∏—Å—å–º–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ!</div>';
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–µ—Ç–∞–ª–∏
                    let details = '<h3>AI Reasoning:</h3><p>' + (data.ai_reasoning || 'N/A') + '</p>';
                    details += '<h3>–í—ã–±—Ä–∞–Ω–Ω—ã–µ —Å–ø–∏–∫–µ—Ä—ã:</h3><ul>';
                    if (data.selected_speakers) {
                        data.selected_speakers.forEach(speaker => {
                            details += '<li>' + (typeof speaker === 'string' ? speaker : speaker.name || JSON.stringify(speaker)) + '</li>';
                        });
                    }
                    details += '</ul>';
                    
                    details += '<h3>–î–∞–Ω–Ω—ã–µ –¥–ª—è —à–∞–±–ª–æ–Ω–∞:</h3><pre>' + JSON.stringify(data.data, null, 2) + '</pre>';
                    
                    responseEl.innerHTML = details;
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é
                    const previewDoc = previewEl.contentDocument || previewEl.contentWindow.document;
                    previewDoc.open();
                    previewDoc.write(data.rendered_html || '');
                    previewDoc.close();
                } else {
                    statusEl.innerHTML = '<div class="result error">‚ùå –û—à–∏–±–∫–∞: ' + (data.error || 'Unknown error') + '</div>';
                    responseEl.innerHTML = '<pre>' + JSON.stringify(data, null, 2) + '</pre>';
                }
            } catch (error) {
                statusEl.innerHTML = '<div class="result error">‚ùå –û—à–∏–±–∫–∞: ' + error.message + '</div>';
                responseEl.innerHTML = '<pre>' + error.stack + '</pre>';
            }
        }
    </script>
</body>
</html>
