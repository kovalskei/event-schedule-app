# üîÑ –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ: –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è —à–∞–±–ª–æ–Ω–æ–≤

## üìã –û–±—â–∞—è —Å—Ö–µ–º–∞ —Ä–∞–±–æ—Ç—ã

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–≥—Ä—É–∂–∞–µ—Ç HTML
         ‚Üì
[/analyze-template] ‚Üí –£–º–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥ + –∞–≤—Ç–æ–Ω–∞–∑–≤–∞–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
         ‚Üì
–®–∞–±–ª–æ–Ω —Å {{–ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏}} + JSON –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
         ‚Üì
–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î (email_templates + template_variables)
         ‚Üì
[/fill-template] ‚Üí –ò–ò –∑–∞–ø–æ–ª–Ω—è–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π
         ‚Üì
–ì–æ—Ç–æ–≤–æ–µ –ø–∏—Å—å–º–æ —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
```

---

## üéØ –≠–¢–ê–ü 1: –ó–∞–≥—Ä—É–∑–∫–∞ HTML

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –æ–±—ã—á–Ω—ã–π HTML –ø–∏—Å—å–º–∞:

```html
<html>
  <body>
    <h1>–ü—Ä–∏–≥–ª–∞—à–∞–µ–º –Ω–∞ –≤–µ–±–∏–Ω–∞—Ä!</h1>
    <p>–°–ø–∏–∫–µ—Ä: –ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤</p>
    <p>–¢–µ–º–∞: –£–≤–µ–ª–∏—á–µ–Ω–∏–µ –ø—Ä–æ–¥–∞–∂</p>
    <p>–î–∞—Ç–∞: 15 –º–∞—è –≤ 19:00</p>
    <a href="#">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</a>
  </body>
</html>
```

---

## ü§ñ –≠–¢–ê–ü 2: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑

### Backend —Ñ—É–Ω–∫—Ü–∏—è: `/analyze-template`

**URL:** `https://functions.poehali.dev/826203af-dede-46f0-89aa-b28b80ac3b03`

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**
1. –ü–∞—Ä—Å–∏—Ç HTML —á–µ—Ä–µ–∑ `HTMLParser`
2. –ò–∑–≤–ª–µ–∫–∞–µ—Ç –≤—Å–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –±–ª–æ–∫–∏
3. –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —É–º–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º
4. –ó–∞–º–µ–Ω—è–µ—Ç —Ç–µ–∫—Å—Ç –Ω–∞ `{{–ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ}}`

### –ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞:

```bash
POST /analyze-template
Content-Type: application/json

{
  "html_content": "<html>...</html>"
}
```

### –ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞:

```json
{
  "template_html": "<html><body><h1>{{webinar_title}}</h1><p>{{speaker_name}}</p>...</body></html>",
  "original_html": "<html>...</html>",
  "variables": [
    {
      "name": "webinar_title",
      "original_text": "–ü—Ä–∏–≥–ª–∞—à–∞–µ–º –Ω–∞ –≤–µ–±–∏–Ω–∞—Ä!",
      "suggested_type": "text",
      "description": "–ö–æ—Ä–æ—Ç–∫–∏–π —Ç–µ–∫—Å—Ç–æ–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç",
      "default_value": "–ü—Ä–∏–≥–ª–∞—à–∞–µ–º –Ω–∞ –≤–µ–±–∏–Ω–∞—Ä!",
      "is_required": true
    },
    {
      "name": "speaker_name",
      "original_text": "–°–ø–∏–∫–µ—Ä: –ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤",
      "suggested_type": "text",
      "description": "–§–ò–û —Å–ø–∏–∫–µ—Ä–∞ –∏–ª–∏ —ç–∫—Å–ø–µ—Ä—Ç–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è",
      "default_value": "–°–ø–∏–∫–µ—Ä: –ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤",
      "is_required": true
    },
    {
      "name": "topic",
      "original_text": "–¢–µ–º–∞: –£–≤–µ–ª–∏—á–µ–Ω–∏–µ –ø—Ä–æ–¥–∞–∂",
      "suggested_type": "text",
      "description": "–ù–∞–∑–≤–∞–Ω–∏–µ –∏–ª–∏ —Ç–µ–º–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è",
      "default_value": "–¢–µ–º–∞: –£–≤–µ–ª–∏—á–µ–Ω–∏–µ –ø—Ä–æ–¥–∞–∂",
      "is_required": true
    },
    {
      "name": "event_date",
      "original_text": "–î–∞—Ç–∞: 15 –º–∞—è –≤ 19:00",
      "suggested_type": "date",
      "description": "–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è",
      "default_value": "–î–∞—Ç–∞: 15 –º–∞—è –≤ 19:00",
      "is_required": true
    },
    {
      "name": "cta_register",
      "original_text": "–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è",
      "suggested_type": "text",
      "description": "–¢–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ –ø—Ä–∏–∑—ã–≤–∞ –∫ –¥–µ–π—Å—Ç–≤–∏—é (CTA)",
      "default_value": "–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è",
      "is_required": true
    }
  ],
  "variables_count": 5
}
```

### üß† –°–ª–æ–≤–∞—Ä—å –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤

–°–∏—Å—Ç–µ–º–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–µ—Ç —Å–ª–µ–¥—É—é—â–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –≤ —Ç–µ–∫—Å—Ç–µ:

| –ö–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ | –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –¢–∏–ø |
|----------------|------------|-----|
| —Å–ø–∏–∫–µ—Ä, —ç–∫—Å–ø–µ—Ä—Ç, –≤–µ–¥—É—â–∏–π | `speaker_name`, `expert_name` | text |
| –¥–∞—Ç–∞, –≤—Ä–µ–º—è, –∫–æ–≥–¥–∞ | `event_date`, `event_time` | date |
| –Ω–∞–∑–≤–∞–Ω–∏–µ, —Ç–µ–º–∞, –∑–∞–≥–æ–ª–æ–≤–æ–∫ | `event_name`, `topic`, `title` | text |
| –≤–µ–±–∏–Ω–∞—Ä, –∫–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏—è | `webinar_title`, `conference_title` | text |
| –æ–ø–∏—Å–∞–Ω–∏–µ, –æ —á–µ–º | `description`, `about` | text |
| —Ä–µ–≥–∏—Å—Ç—Ä, –∑–∞–ø–∏—Å–∞—Ç—å—Å—è | `cta_register`, `cta_signup` | text |
| email, —Ç–µ–ª–µ—Ñ–æ–Ω | `contact_email`, `contact_phone` | text |
| —Ü–µ–Ω–∞, —Å—Ç–æ–∏–º–æ—Å—Ç—å | `price`, `cost` | number |

**Fallback:** –ï—Å–ª–∏ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã:
- –î–ª–∏–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç (>150 —Å–∏–º–≤–æ–ª–æ–≤) ‚Üí `content_block_1`
- –°—Ä–µ–¥–Ω–∏–π —Ç–µ–∫—Å—Ç (>50 —Å–∏–º–≤–æ–ª–æ–≤) ‚Üí `paragraph_1`
- –ö–æ—Ä–æ—Ç–∫–∏–π —Ç–µ–∫—Å—Ç ‚Üí `text_1`

---

## üíæ –≠–¢–ê–ü 3: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î

### –¢–∞–±–ª–∏—Ü–∞: `email_templates`

```sql
INSERT INTO t_p22819116_event_schedule_app.email_templates 
  (event_id, content_type_id, name, html_template, subject_template, original_html)
VALUES 
  (1, 2, '–®–∞–±–ª–æ–Ω –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è', 
   '<html>{{event_name}}...</html>',  -- –®–∞–±–ª–æ–Ω —Å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏
   '{{event_name}} ‚Äî –Ω–µ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç–µ!',
   '<html>–ü—Ä–∏–≥–ª–∞—à–∞–µ–º...</html>');     -- –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π HTML
```

### –¢–∞–±–ª–∏—Ü–∞: `template_variables`

```sql
INSERT INTO t_p22819116_event_schedule_app.template_variables 
  (template_id, variable_name, variable_description, default_value, is_required, variable_type)
VALUES 
  (1, 'speaker_name', '–§–ò–û —Å–ø–∏–∫–µ—Ä–∞ –≤–µ–±–∏–Ω–∞—Ä–∞', '–≠–∫—Å–ø–µ—Ä—Ç', true, 'text'),
  (1, 'event_date', '–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è', '', true, 'date'),
  (1, 'topic', '–û—Å–Ω–æ–≤–Ω–∞—è —Ç–µ–º–∞ —Å–æ–±—ã—Ç–∏—è', '', true, 'text');
```

**–£–Ω–∏–∫–∞–ª—å–Ω—ã–π constraint:** `(template_id, variable_name)` ‚Äî –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –¥—É–±–ª–∏

---

## üé® –≠–¢–ê–ü 4: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–∏—Å—å–º–∞

### Backend —Ñ—É–Ω–∫—Ü–∏—è: `/fill-template`

**URL:** `https://functions.poehali.dev/b48a1389-105b-4007-a99d-d8941c0a38bf`

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**
1. –ó–∞–≥—Ä—É–∂–∞–µ—Ç —à–∞–±–ª–æ–Ω –∏–∑ –ë–î
2. –ó–∞–≥—Ä—É–∂–∞–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏ –∏—Ö –æ–ø–∏—Å–∞–Ω–∏—è
3. –ó–∞–≥—Ä—É–∂–∞–µ—Ç –±–∞–∑—É –∑–Ω–∞–Ω–∏–π (–ø—Ä–æ–≥—Ä–∞–º–º–∞, –±–æ–ª–∏, —Å—Ç–∏–ª—å)
4. –í—ã–∑—ã–≤–∞–µ—Ç OpenAI GPT-4o-mini –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
5. –ü–æ–¥—Å—Ç–∞–≤–ª—è–µ—Ç –∑–Ω–∞—á–µ–Ω–∏—è –≤ —à–∞–±–ª–æ–Ω
6. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≥–æ—Ç–æ–≤–æ–µ –ø–∏—Å—å–º–æ

### –ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞:

```bash
POST /fill-template
Content-Type: application/json

{
  "template_id": 1,
  "event_id": 1,
  "theme": "–ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –Ω–∞ –≤–µ–±–∏–Ω–∞—Ä –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º"
}
```

### –ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞:

```json
{
  "success": true,
  "filled_html": "<html><body><h1>–í–µ–±–∏–Ω–∞—Ä: –£–≤–µ–ª–∏—á–µ–Ω–∏–µ –ø—Ä–æ–¥–∞–∂ —á–µ—Ä–µ–∑ email</h1><p>–ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤</p>...</body></html>",
  "filled_subject": "–í–µ–±–∏–Ω–∞—Ä: –£–≤–µ–ª–∏—á–µ–Ω–∏–µ –ø—Ä–æ–¥–∞–∂ —á–µ—Ä–µ–∑ email ‚Äî –Ω–µ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç–µ!",
  "variables_data": {
    "webinar_title": "–í–µ–±–∏–Ω–∞—Ä: –£–≤–µ–ª–∏—á–µ–Ω–∏–µ –ø—Ä–æ–¥–∞–∂ —á–µ—Ä–µ–∑ email",
    "speaker_name": "–ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤",
    "topic": "–£–≤–µ–ª–∏—á–µ–Ω–∏–µ –ø—Ä–æ–¥–∞–∂ —á–µ—Ä–µ–∑ email",
    "event_date": "15 –º–∞—è –≤ 19:00",
    "cta_register": "–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –±–µ—Å–ø–ª–∞—Ç–Ω–æ"
  },
  "theme": "–ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –Ω–∞ –≤–µ–±–∏–Ω–∞—Ä –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º"
}
```

### üîç –ü—Ä–æ–º–ø—Ç –¥–ª—è –ò–ò

```
–¢—ã ‚Äî –∫–æ–ø–∏—Ä–∞–π—Ç–µ—Ä email-—Ä–∞—Å—Å—ã–ª–æ–∫ –¥–ª—è HR-–º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π.

–¢–≤–æ—è –∑–∞–¥–∞—á–∞: –∑–∞–ø–æ–ª–Ω–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —à–∞–±–ª–æ–Ω–∞ –ø–∏—Å—å–º–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π.

–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π:
# –ü—Ä–æ–≥—Ä–∞–º–º–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è:
- –ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤, –≠–∫—Å–ø–µ—Ä—Ç –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º, –ö–æ–º–ø–∞–Ω–∏—è X {–£–í–ï–õ–ò–ß–ï–ù–ò–ï –ü–†–û–î–ê–ñ}
- ...

# –ë–æ–ª–∏ —Ü–µ–ª–µ–≤–æ–π –∞—É–¥–∏—Ç–æ—Ä–∏–∏:
- –ù–∏–∑–∫–∞—è –∫–æ–Ω–≤–µ—Ä—Å–∏—è email-—Ä–∞—Å—Å—ã–ª–æ–∫
- ...

–¢–µ–º–∞ –ø–∏—Å—å–º–∞: –ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –Ω–∞ –≤–µ–±–∏–Ω–∞—Ä –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º

–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è:
- speaker_name: –§–ò–û —Å–ø–∏–∫–µ—Ä–∞ –≤–µ–±–∏–Ω–∞—Ä–∞ [–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ]
- event_date: –î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è [–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ]
- topic: –û—Å–Ω–æ–≤–Ω–∞—è —Ç–µ–º–∞ —Å–æ–±—ã—Ç–∏—è [–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ]
- cta_register: –¢–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ –ø—Ä–∏–∑—ã–≤–∞ –∫ –¥–µ–π—Å—Ç–≤–∏—é [–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ]

–í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û –≤–∞–ª–∏–¥–Ω—ã–π JSON –æ–±—ä–µ–∫—Ç –≥–¥–µ –∫–ª—é—á–∏ ‚Äî –∏–º–µ–Ω–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö, –∑–Ω–∞—á–µ–Ω–∏—è ‚Äî –∏—Ö –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è.
```

### ‚ö° Fallback –º–µ—Ö–∞–Ω–∏–∑–º

–ï—Å–ª–∏ –ò–ò –Ω–µ –º–æ–∂–µ—Ç –∑–∞–ø–æ–ª–Ω–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é:
1. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `default_value` –∏–∑ —Ç–∞–±–ª–∏—Ü—ã `template_variables`
2. –ï—Å–ª–∏ `default_value` –ø—É—Å—Ç–æ–π ‚Üí –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è `[variable_name]`

---

## üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ë–î

### –¢–∞–±–ª–∏—Ü–∞: `email_templates`

| –ö–æ–ª–æ–Ω–∫–∞ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------|-----|----------|
| id | SERIAL | Primary key |
| event_id | INTEGER | FK –Ω–∞ —Å–æ–±—ã—Ç–∏—è |
| content_type_id | INTEGER | FK –Ω–∞ —Ç–∏–ø –∫–æ–Ω—Ç–µ–Ω—Ç–∞ |
| name | VARCHAR(255) | –ù–∞–∑–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞ |
| html_template | TEXT | **–®–∞–±–ª–æ–Ω —Å {{–ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏}}** |
| subject_template | VARCHAR(255) | –¢–µ–º–∞ –ø–∏—Å—å–º–∞ —Å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏ |
| instructions | TEXT | –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è –ò–ò |
| **original_html** | TEXT | **–û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π HTML –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è** |
| created_at | TIMESTAMP | –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è |
| updated_at | TIMESTAMP | –î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è |

### –¢–∞–±–ª–∏—Ü–∞: `template_variables`

| –ö–æ–ª–æ–Ω–∫–∞ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------|-----|----------|
| id | SERIAL | Primary key |
| template_id | INTEGER | FK –Ω–∞ email_templates |
| **variable_name** | VARCHAR(100) | **–ò–º—è –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π (–Ω–∞–ø—Ä–∏–º–µ—Ä: speaker_name)** |
| **variable_description** | TEXT | **–û–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –ò–ò** |
| default_value | TEXT | –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é |
| is_required | BOOLEAN | –û–±—è–∑–∞—Ç–µ–ª—å–Ω–∞ –ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è |
| variable_type | VARCHAR(50) | –¢–∏–ø: text, date, url, number |
| created_at | TIMESTAMP | –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è |

**Unique constraint:** `(template_id, variable_name)`

---

## üîß –ê–ª–≥–æ—Ä–∏—Ç–º —Ä–∞–±–æ—Ç—ã `analyze-template`

### 1. –ü–∞—Ä—Å–∏–Ω–≥ HTML

```python
class TextExtractor(HTMLParser):
    def handle_data(self, data):
        stripped = data.strip()
        if stripped and len(stripped) > 2:
            self.text_blocks.append({
                'text': stripped,
                'tag': self.current_tag,
                'length': len(stripped)
            })
```

**–ù–∞–π–¥–µ–Ω–Ω—ã–µ –±–ª–æ–∫–∏:**
```python
[
  {'text': '–ü—Ä–∏–≥–ª–∞—à–∞–µ–º –Ω–∞ –≤–µ–±–∏–Ω–∞—Ä!', 'tag': 'h1', 'length': 23},
  {'text': '–°–ø–∏–∫–µ—Ä: –ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤', 'tag': 'p', 'length': 19},
  {'text': '–¢–µ–º–∞: –£–≤–µ–ª–∏—á–µ–Ω–∏–µ –ø—Ä–æ–¥–∞–∂', 'tag': 'p', 'length': 24},
  ...
]
```

### 2. –£–º–Ω–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∏–º–µ–Ω –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö

```python
def suggest_variable_name(text: str, index: int) -> Tuple[str, str]:
    text_lower = text.lower()
    
    # –ü–æ–∏—Å–∫ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤
    if '—Å–ø–∏–∫–µ—Ä' in text_lower:
        return ('speaker_name', 'text')
    elif '–¥–∞—Ç–∞' in text_lower or '–≤—Ä–µ–º—è' in text_lower:
        return ('event_date', 'date')
    # ... –µ—â–µ 30+ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
    
    # Fallback
    if len(text) > 150:
        return (f'content_block_{index + 1}', 'text')
    return (f'text_{index + 1}', 'text')
```

### 3. –ó–∞–º–µ–Ω–∞ —Ç–µ–∫—Å—Ç–∞ –Ω–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ

```python
def convert_to_template(html: str):
    result_html = html
    variables = []
    used_names = set()
    
    for idx, block in enumerate(text_blocks):
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∏–º—è
        var_name = suggest_variable_name(text, idx)
        while var_name in used_names:
            var_name = f'{var_name}_{counter}'
        
        # –ó–∞–º–µ–Ω—è–µ–º –¢–û–õ–¨–ö–û –ø–µ—Ä–≤–æ–µ –≤—Ö–æ–∂–¥–µ–Ω–∏–µ
        placeholder = '{{' + var_name + '}}'
        result_html = result_html.replace(text, placeholder, 1)
        
        variables.append({
            'name': var_name,
            'original_text': text,
            'suggested_type': var_type,
            'description': generate_description(text, var_name),
            'default_value': text if len(text) < 100 else ''
        })
    
    return result_html, variables
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```python
template_html = '<html><body><h1>{{webinar_title}}</h1><p>{{speaker_name}}</p>...</body></html>'

variables = [
  {'name': 'webinar_title', 'original_text': '–ü—Ä–∏–≥–ª–∞—à–∞–µ–º –Ω–∞ –≤–µ–±–∏–Ω–∞—Ä!', ...},
  {'name': 'speaker_name', 'original_text': '–°–ø–∏–∫–µ—Ä: –ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤', ...},
  ...
]
```

---

## üîß –ê–ª–≥–æ—Ä–∏—Ç–º —Ä–∞–±–æ—Ç—ã `fill-template`

### 1. –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –ë–î

```python
# –®–∞–±–ª–æ–Ω
cur.execute("""
    SELECT html_template, subject_template, instructions, original_html 
    FROM email_templates WHERE id = %s
""", (template_id,))

# –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
cur.execute("""
    SELECT variable_name, variable_description, default_value, is_required
    FROM template_variables WHERE template_id = %s
""", (template_id,))

# –ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π
cur.execute("""
    SELECT item_type, content, metadata
    FROM knowledge_store WHERE event_id = %s
""", (event_id,))
```

### 2. –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–∞ –¥–ª—è –ò–ò

```python
system_prompt = f"""
–¢—ã ‚Äî –∫–æ–ø–∏—Ä–∞–π—Ç–µ—Ä email-—Ä–∞—Å—Å—ã–ª–æ–∫.

–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π:
{knowledge_text}

–¢–µ–º–∞ –ø–∏—Å—å–º–∞: {theme}

–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è:
- speaker_name: –§–ò–û —Å–ø–∏–∫–µ—Ä–∞ [–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ]
- event_date: –î–∞—Ç–∞ —Å–æ–±—ã—Ç–∏—è [–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ]
...

–í–µ—Ä–Ω–∏ JSON: {{"speaker_name": "...", "event_date": "..."}}
"""
```

### 3. –í—ã–∑–æ–≤ OpenAI API

```python
response = requests.post(
    'https://api.openai.com/v1/chat/completions',
    headers={'Authorization': f'Bearer {openai_key}'},
    json={
        'model': 'gpt-4o-mini',
        'messages': [
            {'role': 'system', 'content': system_prompt},
            {'role': 'user', 'content': '–ó–∞–ø–æ–ª–Ω–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ'}
        ],
        'temperature': 0.7,
        'max_tokens': 2000
    }
)

variables_data = extract_json_from_response(response)
```

### 4. –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞

```python
def fill_template(template: str, variables_data: Dict[str, str]) -> str:
    result = template
    
    for key, value in variables_data.items():
        pattern = r'\{\{' + re.escape(key) + r'\}\}'
        result = re.sub(pattern, str(value), result)
    
    return result

filled_html = fill_template(html_template, variables_data)
```

---

## üéØ Best Practices

### ‚úÖ –•–æ—Ä–æ—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏:

1. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ–ø–∏—Å–∞—Ç–µ–ª—å–Ω—ã–µ –∏–º–µ–Ω–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö**
   ```
   ‚úÖ speaker_name, event_date, cta_register
   ‚ùå var1, text2, field3
   ```

2. **–î–æ–±–∞–≤–ª—è–π—Ç–µ –ø–æ–¥—Ä–æ–±–Ω—ã–µ –æ–ø–∏—Å–∞–Ω–∏—è –¥–ª—è –ò–ò**
   ```python
   variable_description = "–§–ò–û —Å–ø–∏–∫–µ—Ä–∞ –≤–µ–±–∏–Ω–∞—Ä–∞, –≤–∫–ª—é—á–∞—è –¥–æ–ª–∂–Ω–æ—Å—Ç—å –∏ –∫–æ–º–ø–∞–Ω–∏—é"
   ```

3. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ default_value –¥–ª—è –≤–∞–∂–Ω—ã—Ö –ø–æ–ª–µ–π**
   ```python
   default_value = "–≠–∫—Å–ø–µ—Ä—Ç"  # –ï—Å–ª–∏ –ò–ò –Ω–µ –Ω–∞–π–¥–µ—Ç —Å–ø–∏–∫–µ—Ä–∞
   ```

4. **–£–∫–∞–∑—ã–≤–∞–π—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π variable_type**
   ```
   text ‚Üí –æ–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç
   date ‚Üí –¥–∞—Ç—ã –∏ –≤—Ä–µ–º—è
   url ‚Üí —Å—Å—ã–ª–∫–∏
   number ‚Üí —á–∏—Å–ª–∞ –∏ —Ü–µ–Ω—ã
   ```

### ‚ùå –ß–µ–≥–æ –∏–∑–±–µ–≥–∞—Ç—å:

1. **–ù–µ –¥—É–±–ª–∏—Ä—É–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ**
   ```
   ‚ùå speaker_name, speaker_name_1, speaker
   ‚úÖ speaker_name, speaker_job, speaker_company
   ```

2. **–ù–µ —Å–æ–∑–¥–∞–≤–∞–π—Ç–µ —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö**
   ```
   ‚ùå 50+ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –≤ –æ–¥–Ω–æ–º —à–∞–±–ª–æ–Ω–µ
   ‚úÖ 5-15 –∫–ª—é—á–µ–≤—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
   ```

3. **–ù–µ –¥–µ–ª–∞–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–º–∏**
   ```
   ‚ùå {{full_description_of_event_with_all_details}}
   ‚úÖ {{event_description}}
   ```

---

## üß™ –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ü—Ä–∏–º–µ—Ä 1: –ü—Ä–æ—Å—Ç–æ–µ –ø–∏—Å—å–º–æ-–ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ

**HTML –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:**
```html
<h1>–ü—Ä–∏–≥–ª–∞—à–∞–µ–º –Ω–∞ –≤–µ–±–∏–Ω–∞—Ä!</h1>
<p>–°–ø–∏–∫–µ—Ä: –ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤</p>
<p>–ö–æ–≥–¥–∞: 15 –º–∞—è –≤ 19:00</p>
<a href="#">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</a>
```

**–ü–æ—Å–ª–µ analyze-template:**
```html
<h1>{{webinar_title}}</h1>
<p>{{speaker_name}}</p>
<p>{{event_date}}</p>
<a href="#">{{cta_register}}</a>
```

**–ü–æ—Å–ª–µ fill-template:**
```html
<h1>–í–µ–±–∏–Ω–∞—Ä: –£–≤–µ–ª–∏—á–µ–Ω–∏–µ –ø—Ä–æ–¥–∞–∂ —á–µ—Ä–µ–∑ email</h1>
<p>–ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤, –≠–∫—Å–ø–µ—Ä—Ç –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º</p>
<p>15 –º–∞—è 2024 –≤ 19:00 –ú–°–ö</p>
<a href="#">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –±–µ—Å–ø–ª–∞—Ç–Ω–æ</a>
```

### –ü—Ä–∏–º–µ—Ä 2: –°–ª–æ–∂–Ω–æ–µ –ø–∏—Å—å–º–æ —Å –ø—Ä–æ–≥—Ä–∞–º–º–æ–π

**HTML –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:**
```html
<h1>–ö–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏—è HR Tech 2024</h1>
<p>3 –¥–Ω—è. 20 —Å–ø–∏–∫–µ—Ä–æ–≤. 500 —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤.</p>
<ul>
  <li>–û—Ç–∫—Ä—ã—Ç–∏–µ: 10:00 - –ï–∫–∞—Ç–µ—Ä–∏–Ω–∞ –°–º–∏—Ä–Ω–æ–≤–∞</li>
  <li>–ü–∞–Ω–µ–ª—å–Ω–∞—è –¥–∏—Å–∫—É—Å—Å–∏—è: 11:30</li>
  <li>–ù–µ—Ç–≤–æ—Ä–∫–∏–Ω–≥: 14:00</li>
</ul>
```

**–ü–æ—Å–ª–µ analyze-template:**
```html
<h1>{{event_name}}</h1>
<p>{{event_stats}}</p>
<ul>
  <li>{{session_1}}</li>
  <li>{{session_2}}</li>
  <li>{{session_3}}</li>
</ul>
```

**–ü–æ—Å–ª–µ fill-template:**
```html
<h1>–ö–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏—è HR Tech 2024: –ë—É–¥—É—â–µ–µ –Ω–∞–π–º–∞</h1>
<p>3 –¥–Ω—è –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ–≥–æ –æ–±—É—á–µ–Ω–∏—è. 20+ —ç–∫—Å–ø–µ—Ä—Ç–æ–≤. 500 HR-—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤.</p>
<ul>
  <li>–û—Ç–∫—Ä—ã—Ç–∏–µ: 10:00 - –ï–∫–∞—Ç–µ—Ä–∏–Ω–∞ –°–º–∏—Ä–Ω–æ–≤–∞, HRD –Ø–Ω–¥–µ–∫—Å: "–ò–ò –≤ —Ä–µ–∫—Ä—É—Ç–∏–Ω–≥–µ"</li>
  <li>–ü–∞–Ω–µ–ª—å–Ω–∞—è –¥–∏—Å–∫—É—Å—Å–∏—è: 11:30 - "–£–¥–∞–ª–µ–Ω–Ω–∞—è —Ä–∞–±–æ—Ç–∞: –≤—ã–∑–æ–≤—ã 2024"</li>
  <li>–ù–µ—Ç–≤–æ—Ä–∫–∏–Ω–≥: 14:00 - –∑–Ω–∞–∫–æ–º—Å—Ç–≤–æ —Å –∫–æ–ª–ª–µ–≥–∞–º–∏ –æ—Ç—Ä–∞—Å–ª–∏</li>
</ul>
```

---

## üêõ Troubleshooting

### –ü—Ä–æ–±–ª–µ–º–∞: –ò–ò –Ω–µ –∑–∞–ø–æ–ª–Ω—è–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

**–†–µ—à–µ–Ω–∏–µ:**
1. –£–ª—É—á—à–∏—Ç–µ `variable_description` ‚Äî –¥–æ–±–∞–≤—å—Ç–µ –±–æ–ª—å—à–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –±–∞–∑—É –∑–Ω–∞–Ω–∏–π ‚Äî –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ª–∏ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è
3. –£–≤–µ–ª–∏—á—å—Ç–µ `max_tokens` –≤ –∑–∞–ø—Ä–æ—Å–µ –∫ OpenAI
4. –î–æ–±–∞–≤—å—Ç–µ –ø—Ä–∏–º–µ—Ä—ã –≤ `instructions` —à–∞–±–ª–æ–Ω–∞

### –ü—Ä–æ–±–ª–µ–º–∞: –î—É–±–ª–∏–∫–∞—Ç—ã –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö

**–†–µ—à–µ–Ω–∏–µ:**
```sql
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥—É–±–ª–∏
SELECT template_id, variable_name, COUNT(*)
FROM template_variables
GROUP BY template_id, variable_name
HAVING COUNT(*) > 1;

-- –£–¥–∞–ª–∏—Ç—å –¥—É–±–ª–∏ (–æ—Å—Ç–∞–≤–∏—Ç—å —Å–∞–º—É—é —Ä–∞–Ω–Ω—é—é)
DELETE FROM template_variables
WHERE id NOT IN (
  SELECT MIN(id) FROM template_variables
  GROUP BY template_id, variable_name
);
```

### –ü—Ä–æ–±–ª–µ–º–∞: HTML —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –º–µ–Ω—è–µ—Ç—Å—è –ø–æ—Å–ª–µ –ø–∞—Ä—Å–∏–Ω–≥–∞

**–†–µ—à–µ–Ω–∏–µ:**
- `original_html` —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ë–î –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤–∞–ª–∏–¥–∞—Ç–æ—Ä HTML –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π
- –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ HTML –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç JavaScript

---

## üìà –ú–µ—Ç—Ä–∏–∫–∏ —Å–∏—Å—Ç–µ–º—ã

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:

- **analyze-template:** ~200-500ms (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ä–∞–∑–º–µ—Ä–∞ HTML)
- **fill-template:** ~2-5 —Å–µ–∫—É–Ω–¥ (–æ—Å–Ω–æ–≤–Ω–æ–µ –≤—Ä–µ–º—è ‚Äî –≤—ã–∑–æ–≤ OpenAI)

### –õ–∏–º–∏—Ç—ã:

- –ú–∞–∫—Å–∏–º—É–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –Ω–∞ —à–∞–±–ª–æ–Ω: 50
- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ `variable_name`: 100 —Å–∏–º–≤–æ–ª–æ–≤
- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ `html_template`: unlimited (TEXT)

### –¢–æ—á–Ω–æ—Å—Ç—å —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è:

- –°–ø–∏–∫–µ—Ä—ã: ~90%
- –î–∞—Ç—ã/–≤—Ä–µ–º—è: ~85%
- CTA –∫–Ω–æ–ø–∫–∏: ~95%
- Generic —Ç–µ–∫—Å—Ç: ~70%

---

## üöÄ Roadmap

### –ü–ª–∞–Ω—ã –Ω–∞ –±—É–¥—É—â–µ–µ:

1. **ML-–∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Ç–∏–ø–æ–≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö** (–≤–º–µ—Å—Ç–æ regex)
2. **–ü–æ–¥–¥–µ—Ä–∂–∫–∞ CSS-—Å–µ–ª–µ–∫—Ç–æ—Ä–æ–≤** –¥–ª—è —Ç–æ—á–Ω–æ–π –ø—Ä–∏–≤—è–∑–∫–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
3. **–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏** –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
4. **–í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–æ–≤** (A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)
5. **–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –≥–æ—Ç–æ–≤—ã—Ö —à–∞–±–ª–æ–Ω–æ–≤** —Å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏

---

**–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞:** 2025-11-02  
**–í–µ—Ä—Å–∏—è —Å–∏—Å—Ç–µ–º—ã:** 1.0  
**Backend —Ñ—É–Ω–∫—Ü–∏–∏:**
- `analyze-template`: https://functions.poehali.dev/826203af-dede-46f0-89aa-b28b80ac3b03
- `fill-template`: https://functions.poehali.dev/b48a1389-105b-4007-a99d-d8941c0a38bf
